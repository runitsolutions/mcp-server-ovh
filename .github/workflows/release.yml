name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --include=dev

    - name: Run linter
      run: npm run lint

    - name: Run typecheck
      run: npm run typecheck

    - name: Build project
      run: npm run build

    - name: Run endpoint tests
      run: npm run test:endpoints
      env:
        OVH_APP_KEY: ${{ secrets.OVH_APP_KEY }}
        OVH_APP_SECRET: ${{ secrets.OVH_APP_SECRET }}
        OVH_CONSUMER_KEY: ${{ secrets.OVH_CONSUMER_KEY }}
        OVH_ENDPOINT: ovh-us

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          ## What's Changed

          ### üöÄ New Features
          - Complete MCP OVH server with comprehensive endpoint coverage
          - 17/17 OVH API endpoints verified and working
          - Enhanced MCP tools for IPs, vRack, load balancers, SSL, and DBaaS logs
          - Professional test suite with Jest configuration
          - Full English translation and documentation

          ### üîí Security
          - Removed hardcoded credentials
          - Environment variable support for secure configuration
          - Enhanced .gitignore for credential protection

          ### üõ†Ô∏è Technical Improvements
          - TypeScript compilation with proper error handling
          - ES modules support in Jest configuration
          - Comprehensive test utilities and helpers
          - CI/CD pipeline with automated testing

          ### üìä Verified Endpoints
          - User account management (/me, /me/bill, /me/payment/method)
          - Service listings (/service, /services)
          - Infrastructure (/dedicated/server, /vps, /cloud/project)
          - Network services (/ip, /ipLoadbalancing, /vrack)
          - Additional services (/ssl, /dbaas/logs, /license/windows, /metrics)
        draft: false
        prerelease: false
